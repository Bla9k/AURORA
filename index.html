<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora | Premium Anime Experience</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                        serif: ['Cormorant Garamond', 'serif'],
                    },
                    colors: {
                        premium: {
                            black: '#020204',
                            gold: '#D4AF37',
                            goldLight: '#F3E5AB',
                            violet: '#240046',
                            text: '#E2E2E2',
                            dim: 'rgba(255, 255, 255, 0.4)'
                        }
                    },
                    animation: {
                        'cinematic-fade': 'cinematicFade 2s ease-out forwards',
                        'reveal-up': 'revealUp 1.2s cubic-bezier(0.22, 1, 0.36, 1) forwards',
                        'breathe': 'breathe 4s ease-in-out infinite',
                        'progress': 'progress 8s linear forwards',
                        'title-reveal': 'titleReveal 2.5s cubic-bezier(0.22, 1, 0.36, 1) forwards',
                        'spin-slow': 'spin 12s linear infinite', 
                    },
                    keyframes: {
                        cinematicFade: {
                            '0%': { opacity: '0', filter: 'blur(10px)' },
                            '100%': { opacity: '1', filter: 'blur(0)' },
                        },
                        titleReveal: {
                            '0%': { opacity: '0', letterSpacing: '0.1em', transform: 'scale(1.1)', filter: 'blur(12px)' },
                            '40%': { opacity: '1', filter: 'blur(0)' },
                            '100%': { opacity: '1', letterSpacing: '0.4em', transform: 'scale(1)', filter: 'blur(0)' },
                        },
                        revealUp: {
                            '0%': { transform: 'translateY(40px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        breathe: {
                            '0%, 100%': { transform: 'scale(1)', opacity: '0.8' },
                            '50%': { transform: 'scale(1.05)', opacity: '0.4' },
                        },
                        progress: {
                            '0%': { width: '0%' },
                            '100%': { width: '100%' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Settings */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        body {
            background-color: #020204;
            color: #E2E2E2;
            overflow-x: hidden;
        }

        /* Glassmorphism Refined */
        .glass-premium {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid transparent; 
        }

        /* Smooth Image Hover */
        .cinematic-card img {
            transition: transform 0.8s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .cinematic-card:hover img {
            transform: scale(1.08);
        }

        /* Background Layer Transitions */
        .bg-layer {
            transition: opacity 1.5s ease-in-out;
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .active-bg { opacity: 0.6; z-index: 1; }
        .inactive-bg { opacity: 0; z-index: 0; }
        
        /* Focus/Blur Logic */
        .blur-target {
            transition: filter 0.6s ease, transform 0.6s ease, opacity 0.6s ease;
        }
        .app-blurred .blur-target {
            filter: blur(12px) brightness(0.6);
            transform: scale(0.98);
        }
        .menu-btn {
            transition: opacity 0.4s ease, filter 0.4s ease, transform 0.4s ease;
        }
        .app-blurred .menu-btn {
            opacity: 0;
            filter: blur(5px);
            transform: translateY(-10px);
            pointer-events: none;
        }

        /* Search Bar Sphere Animation */
        #search-container {
            width: 3rem; 
            height: 3rem; 
            overflow: hidden;
            border-radius: 9999px; 
            transition: width 0.5s cubic-bezier(0.22, 1, 0.36, 1), background-color 0.3s;
        }
        #search-container.search-expanded {
            width: 320px;
            background: rgba(20, 20, 23, 0.95);
            border-color: rgba(212, 175, 55, 0.3);
        }
        
        .search-input-wrapper {
            width: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
            white-space: nowrap; 
        }
        .search-expanded .search-input-wrapper {
            width: 100%;
            opacity: 1;
            transition: opacity 0.3s ease 0.2s; 
        }

        /* Menu Link Underlining */
        .menu-link {
            position: relative;
            display: inline-block;
            text-decoration: none; 
        }
        .menu-link::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -5px; 
            width: 0%;
            height: 2px; 
            background: #D4AF37;
            transition: width 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .menu-link:hover { color: #F3E5AB; }
        .menu-link:hover::after { width: 100%; }

        /* View Transitions */
        #details-view, #discover-view {
            transition: opacity 0.6s cubic-bezier(0.22, 1, 0.36, 1), visibility 0.6s;
        }

        /* Search Results Overlay */
        #search-results-overlay {
            transition: opacity 0.4s ease, visibility 0.4s;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .accordion-open {
            max-height: 1000px;
        }
    </style>
</head>
<body class="antialiased selection:bg-premium-gold selection:text-black">

    <!-- INTRO SEQUENCE -->
    <div id="intro-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#020204]">
        <div class="relative flex flex-col items-center justify-center w-full h-full">
            <div class="absolute inset-0 flex items-center justify-center opacity-30">
                <div class="w-64 h-64 bg-premium-gold blur-[120px] rounded-full animate-pulse"></div>
            </div>
            <div class="overflow-hidden relative z-10 flex flex-col items-center">
                <div class="w-px h-0 bg-gradient-to-b from-transparent via-premium-gold to-transparent animate-[height_1s_ease-out_forwards] mb-8" style="height: 100px;"></div>
                <h1 class="text-5xl md:text-7xl font-serif italic text-white opacity-0 animate-title-reveal text-center">
                    AURORA
                </h1>
                <p class="mt-6 text-[10px] font-sans tracking-[0.4em] text-premium-goldLight uppercase opacity-0 animate-cinematic-fade" style="animation-delay: 1s;">
                    Immersive Anime Streaming
                </p>
            </div>
        </div>
    </div>

    <!-- DETAILS PAGE OVERLAY (z-[85] to be above Discover z-[80]) -->
    <div id="details-view" class="fixed inset-0 z-[85] bg-[#020204] opacity-0 invisible overflow-y-auto">
        <button onclick="closeDetails()" class="fixed top-8 right-8 z-[90] p-4 rounded-full glass-premium text-white/70 hover:text-white hover:border-white transition-all duration-300 group">
            <i data-lucide="x" class="w-6 h-6 group-hover:rotate-90 transition-transform duration-500"></i>
        </button>
        <div id="details-content" class="min-h-screen relative">
            <!-- Content Injected via JS -->
        </div>
    </div>

    <!-- DISCOVER PAGE OVERLAY (z-[80]) -->
    <div id="discover-view" class="fixed inset-0 z-[80] bg-[#020204] opacity-0 invisible overflow-y-auto transition-all duration-500">
        <button onclick="closeDiscover()" class="fixed top-8 right-8 z-[90] p-4 rounded-full glass-premium text-white/70 hover:text-white hover:border-white transition-all duration-300 group">
            <i data-lucide="x" class="w-6 h-6 group-hover:rotate-90 transition-transform duration-500"></i>
        </button>
        
        <div class="min-h-screen pt-24 px-6 md:px-24">
            <h2 class="text-5xl md:text-7xl font-serif italic text-white mb-6">Discover</h2>
            <p class="text-white/50 mb-8 max-w-lg">Curate your own journey. Select tags and search to filter.</p>
            
            <div class="mb-10 max-w-2xl">
                <div class="glass-premium h-16 rounded-full flex items-center px-6 border border-white/10 focus-within:border-premium-gold/50 transition-colors">
                    <i data-lucide="search" class="w-6 h-6 text-white/50"></i>
                    <input type="text" id="discover-input" placeholder="Search specifically in Discover..." class="bg-transparent border-none outline-none text-white text-lg w-full font-sans placeholder-white/30 ml-4 h-full">
                </div>
            </div>

            <div class="flex flex-wrap gap-3 mb-16" id="genre-container"></div>

            <div class="flex justify-between items-end mb-6 border-b border-white/10 pb-4">
                <h3 class="text-xl font-serif italic text-white" id="discover-count">Results</h3>
            </div>
            
            <div id="discover-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6 pb-20">
                <div class="col-span-full text-center text-white/30 italic mt-10">Select genres or search to begin...</div>
            </div>
        </div>
    </div>

    <!-- SEARCH RESULTS OVERLAY (z-[70]) -->
    <div id="search-results-overlay" class="fixed inset-0 z-[70] bg-[#020204]/95 opacity-0 invisible pt-32 px-6 md:px-24 overflow-y-auto">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-end mb-8 border-b border-white/10 pb-4">
                <h3 class="text-2xl font-serif italic text-white">Search Results</h3>
                <button onclick="closeSearch()" class="text-xs font-sans tracking-widest text-white/50 hover:text-white uppercase">Close</button>
            </div>
            <div id="search-results-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6 pb-20"></div>
        </div>
    </div>

    <!-- MENU OVERLAY (z-[90] to cover details if needed, but below button) -->
    <div id="menu-overlay" class="fixed inset-0 z-[90] bg-black opacity-0 invisible flex flex-col justify-center items-center w-full h-full">
        <nav class="flex flex-col items-center space-y-8 text-center relative z-10">
            <div class="menu-item-anim opacity-0 translate-y-10 text-[10px] font-sans tracking-[0.3em] text-premium-gold mb-4 uppercase">Navigation</div>
            <div class="menu-item-anim opacity-0 translate-y-10"><a href="#" onclick="toggleMenu(); return false;" class="menu-link text-4xl md:text-6xl font-serif italic text-white">Home</a></div>
            <div class="menu-item-anim opacity-0 translate-y-10"><a href="#" onclick="openDiscover(); toggleMenu(); return false;" class="menu-link text-4xl md:text-6xl font-serif italic text-white/80">Discover</a></div>
            <div class="menu-item-anim opacity-0 translate-y-10"><a href="#" class="menu-link text-4xl md:text-6xl font-serif italic text-white/80">Simulcasts</a></div>
            <div class="menu-item-anim opacity-0 translate-y-10 pt-12 flex gap-8">
                <a href="#" class="text-sm font-sans tracking-widest text-white/40 hover:text-premium-gold transition-colors">LOGIN</a>
            </div>
        </nav>
        
        <div class="menu-item-anim opacity-0 translate-y-10 absolute bottom-10 text-[10px] text-white/20 tracking-widest font-sans">
            POWERED BY KITSU API
        </div>
        
        <div class="absolute inset-0 pointer-events-none">
             <div class="absolute left-1/4 top-0 bottom-0 w-px bg-white/5 menu-line-deco scale-y-0 origin-top"></div>
             <div class="absolute right-1/4 top-0 bottom-0 w-px bg-white/5 menu-line-deco scale-y-0 origin-bottom"></div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="opacity-0 transition-opacity duration-1000 w-full min-h-screen relative">

        <!-- TOP RIGHT ACTIONS (z-[75]) -->
        <div class="fixed top-8 right-8 z-[75] flex flex-col items-end gap-6">
            <div id="search-container" class="glass-premium flex items-center justify-end">
                <div class="search-input-wrapper flex-1 pl-4 pr-2">
                    <input type="text" id="search-input" placeholder="Type to search..." class="bg-transparent border-none outline-none text-white text-sm w-full font-sans placeholder-white/30 h-full">
                </div>
                <button onclick="toggleSearch()" class="w-12 h-12 flex items-center justify-center text-white/70 hover:text-premium-gold transition-colors shrink-0 rounded-full">
                    <i data-lucide="search" class="w-5 h-5"></i>
                </button>
            </div>
            <button id="menu-btn" onclick="toggleMenu()" class="group w-12 h-12 rounded-full glass-premium flex items-center justify-center text-white/70 hover:text-white transition-all hover:scale-110 relative z-[100]">
                <div class="flex flex-col gap-[5px] items-center justify-center">
                    <span id="menu-line-1" class="w-5 h-[1px] bg-current block menu-line"></span>
                    <span id="menu-line-2" class="w-3 h-[1px] bg-current block menu-line transform translate-x-1"></span>
                    <span id="menu-line-3" class="w-5 h-[1px] bg-current block menu-line"></span>
                </div>
            </button>
        </div>

        <!-- BLUR TARGET WRAPPER -->
        <div id="content-wrapper" class="blur-target">
            
            <!-- DYNAMIC HERO BACKGROUND -->
            <div class="fixed inset-0 w-full h-full -z-10 overflow-hidden bg-[#020204]">
                <div id="hero-bg-1" class="bg-layer active-bg"></div>
                <div id="hero-bg-2" class="bg-layer inactive-bg"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-[#020204] via-[#020204]/60 to-transparent z-10 pointer-events-none"></div>
                <div class="absolute inset-0 bg-gradient-to-r from-[#020204] via-transparent to-[#020204]/80 z-10 pointer-events-none"></div>
            </div>

            <!-- BRANDING -->
            <div class="absolute top-8 left-8 z-50">
                <h2 class="text-xl font-serif italic text-white tracking-widest drop-shadow-md">AURORA</h2>
            </div>

            <!-- SCROLLABLE CONTENT -->
            <main class="w-full pb-20">
                <!-- HERO SECTION -->
                <section class="min-h-screen flex flex-col justify-center px-6 md:px-24 relative pt-32 pb-32">
                    <div id="hero-content" class="relative z-20">
                        <div class="hero-anim flex items-center gap-3 mb-6">
                            <span class="h-[1px] w-8 bg-premium-gold"></span>
                            <span id="hero-tag" class="text-xs font-sans tracking-[0.2em] text-premium-goldLight uppercase">Trending Now</span>
                        </div>
                        <h1 class="hero-anim font-sans font-light text-5xl md:text-8xl lg:text-9xl text-white tracking-tighter leading-none">
                            <span id="hero-title-main">LOADING</span><br>
                            <span id="hero-title-sub" class="font-serif italic text-white/90">...</span>
                        </h1>
                        <p id="hero-desc" class="hero-anim mt-8 max-w-xl text-sm md:text-base text-premium-dim font-light leading-relaxed line-clamp-3">
                            Fetching data from Kitsu API...
                        </p>
                        <div class="hero-anim mt-10">
                            <button onclick="openDetails(-1)" class="group flex items-center gap-4 text-white hover:text-premium-gold transition-colors duration-500">
                                <div class="w-16 h-16 rounded-full border border-white/20 flex items-center justify-center group-hover:border-premium-gold/50 group-hover:scale-105 transition-all">
                                    <i data-lucide="info" class="w-5 h-5 fill-current ml-1"></i>
                                </div>
                                <span class="text-xs font-sans tracking-[0.2em] uppercase">View Details</span>
                            </button>
                        </div>
                    </div>
                    <div class="w-full md:w-auto relative mt-16 md:mt-0 md:absolute md:bottom-10 md:left-24 md:right-24 flex flex-col-reverse md:flex-row gap-8 md:gap-0 items-start md:items-center md:justify-between z-20">
                        <div class="flex items-center gap-4">
                            <span id="slide-current" class="text-xs font-mono text-white">01</span>
                            <div class="w-32 h-[1px] bg-white/10 relative overflow-hidden">
                                <div id="slide-progress" class="absolute inset-0 bg-premium-gold w-0"></div>
                            </div>
                            <span id="slide-total" class="text-xs font-mono text-white/40">05</span>
                        </div>
                        <div class="flex items-center gap-8">
                            <button onclick="prevSlide()" class="group flex items-center gap-3 text-white/40 hover:text-premium-gold transition-colors">
                                <i data-lucide="arrow-left" class="w-4 h-4 transition-transform duration-300 group-hover:-translate-x-1"></i>
                                <span class="text-xs font-sans tracking-[0.2em] uppercase">Prev</span>
                            </button>
                            <div class="w-px h-4 bg-white/10"></div>
                            <button onclick="nextSlide()" class="group flex items-center gap-3 text-white/40 hover:text-premium-gold transition-colors">
                                <span class="text-xs font-sans tracking-[0.2em] uppercase">Next</span>
                                <i data-lucide="arrow-right" class="w-4 h-4 transition-transform duration-300 group-hover:translate-x-1"></i>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- CONTENT SECTIONS -->
                <div class="relative z-10 -mt-20 px-6 md:px-24 space-y-32">
                    <!-- Section 1: Curated -->
                    <section>
                        <div class="flex justify-between items-end mb-12 border-b border-white/10 pb-4">
                            <h3 class="text-3xl font-serif italic text-white">Highest Rated</h3>
                        </div>
                        <div class="relative group/curated">
                            <button onclick="scrollCurated(-1)" class="absolute left-0 top-0 bottom-8 z-20 w-16 bg-gradient-to-r from-black/80 to-transparent opacity-0 group-hover/curated:opacity-100 transition-opacity duration-300 flex items-center justify-center text-white hover:text-premium-gold">
                                <i data-lucide="chevron-left" class="w-8 h-8"></i>
                            </button>
                            <div class="flex gap-8 overflow-x-auto pb-8 no-scrollbar snap-x scroll-smooth" id="curated-row"></div>
                            <button onclick="scrollCurated(1)" class="absolute right-0 top-0 bottom-8 z-20 w-16 bg-gradient-to-l from-black/80 to-transparent opacity-0 group-hover/curated:opacity-100 transition-opacity duration-300 flex items-center justify-center text-white hover:text-premium-gold">
                                <i data-lucide="chevron-right" class="w-8 h-8"></i>
                            </button>
                        </div>
                    </section>

                    <!-- Section 2: Trending -->
                    <section>
                        <div class="mb-12 flex justify-between items-end">
                            <div>
                                <span class="text-xs text-premium-gold tracking-widest uppercase mb-2 block">Global</span>
                                <h3 id="grid-title" class="text-3xl font-serif italic text-white">Most Popular</h3>
                            </div>
                            <button onclick="shuffleTrending()" class="group flex items-center gap-2 text-white/50 hover:text-premium-gold transition-colors pb-1">
                                <span class="text-xs font-sans tracking-widest uppercase">Shuffle</span>
                                <i data-lucide="shuffle" class="w-4 h-4 transition-transform duration-500 group-hover:rotate-180"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-y-16 gap-x-8 transition-all duration-500 ease-in-out" id="trending-grid"></div>
                        <div class="flex justify-center mt-12">
                            <button onclick="toggleTrendingExpansion()" id="trending-toggle-btn" class="group flex flex-col items-center gap-2 text-white/40 hover:text-white transition-colors">
                                <span class="text-xs font-sans tracking-[0.2em] uppercase group-hover:text-premium-gold transition-colors" id="trending-btn-text">Show More</span>
                                <i data-lucide="chevron-down" id="trending-btn-icon" class="w-5 h-5 transition-transform duration-300 group-hover:text-premium-gold"></i>
                            </button>
                        </div>
                    </section>

                    <!-- Section 3: Destiny Summon (Embedded Gacha - Optimized for Mobile) -->
                    <section id="gacha-section" class="py-24 relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-b from-transparent via-premium-violet/5 to-transparent pointer-events-none"></div>
                        
                        <div class="flex flex-col items-center text-center mb-12 relative z-10">
                            <h3 class="text-4xl font-serif italic text-white mb-3">Destiny Summon</h3>
                            <p class="text-xs text-white/40 font-sans tracking-[0.2em] uppercase">Offer genres to the void</p>
                        </div>

                        <div class="flex justify-center flex-wrap gap-3 mb-20 px-4 min-h-[40px] transition-all" id="gacha-genre-pills"></div>

                        <!-- The Magic Circle - Responsive -->
                        <div class="relative w-full flex flex-col justify-center items-center">
                            
                            <!-- Responsive Container -->
                            <div class="relative w-[300px] h-[300px] md:w-[600px] md:h-[600px] flex items-center justify-center">
                                <!-- Rings: Mobile vs Desktop Sizes -->
                                <div id="magic-ring-1" class="absolute w-[190px] h-[190px] md:w-[380px] md:h-[380px] rounded-full border-t border-l border-white/20 opacity-70"></div>
                                <div id="magic-ring-2" class="absolute w-[250px] h-[250px] md:w-[500px] md:h-[500px] rounded-full border-b border-r border-premium-gold/40 opacity-60 flex items-center justify-center"></div>
                                <div id="magic-ring-3" class="absolute w-[300px] h-[300px] md:w-[600px] md:h-[600px] rounded-full border border-dashed border-white/5 opacity-40"></div>

                                <!-- Card Container -->
                                <div id="summon-container" class="relative z-10 w-[120px] md:w-[160px] aspect-[2/3] bg-white/5 rounded-lg border border-white/10 flex items-center justify-center overflow-hidden backdrop-blur-sm shadow-[0_0_30px_rgba(0,0,0,0.5)]">
                                    <div id="summon-placeholder" class="text-center opacity-50">
                                        <div class="w-10 h-10 border border-white/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                            <i data-lucide="sparkles" class="w-4 h-4 text-premium-gold"></i>
                                        </div>
                                        <span class="text-[9px] uppercase tracking-widest text-white/50">Awaiting<br>Offering</span>
                                    </div>
                                    <!-- Result Content -->
                                    <div id="summon-result" class="absolute inset-0 opacity-0 bg-black group cursor-pointer" onclick="if(state.gachaResult) openDetails(state.gachaResult)">
                                        <img id="summon-img" src="" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity duration-700">
                                        <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black via-black/80 to-transparent">
                                            <h4 id="summon-title" class="text-white font-serif italic text-sm line-clamp-2 leading-tight mb-1"></h4>
                                            <p id="summon-meta" class="text-[8px] text-premium-gold uppercase tracking-widest"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-12 z-20">
                                <button onclick="triggerGachaPull()" class="group relative px-10 py-4 bg-transparent overflow-hidden">
                                    <span class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/5 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700 ease-in-out"></span>
                                    <span class="absolute inset-0 border border-white/20 rounded-full group-hover:border-premium-gold/50 transition-colors duration-500"></span>
                                    <div class="flex items-center gap-3">
                                        <span class="text-xs font-sans font-bold uppercase tracking-[0.3em] text-white/70 group-hover:text-white transition-colors">Summon</span>
                                        <i data-lucide="star" class="w-3 h-3 text-premium-gold opacity-0 group-hover:opacity-100 transition-opacity transform group-hover:rotate-180 duration-500"></i>
                                    </div>
                                </button>
                                <button onclick="resetGachaState()" class="block mx-auto mt-4 text-[10px] text-white/20 hover:text-white/50 uppercase tracking-widest transition-colors">Reset Circle</button>
                            </div>

                        </div>
                    </section>

                    <!-- Footer -->
                    <footer class="py-20 border-t border-white/5 flex flex-col md:flex-row justify-between items-start gap-10">
                        <div>
                            <h2 class="text-2xl font-serif italic mb-4">AURORA</h2>
                            <p class="text-xs text-white/30 max-w-xs leading-relaxed">Powered by Kitsu API. Cinematic interface design.</p>
                        </div>
                    </footer>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- API Services ---
        const API_BASE = 'https://kitsu.io/api/edge';

        class AnimeService {
            static async fetchTrending() {
                try {
                    const res = await fetch(`${API_BASE}/trending/anime`);
                    const data = await res.json();
                    return this.normalize(data.data);
                } catch (e) { console.error(e); return []; }
            }

            static async fetchRandomHero() {
                try {
                    const offset = Math.floor(Math.random() * 500);
                    const res = await fetch(`${API_BASE}/anime?sort=popularityRank&page[limit]=5&page[offset]=${offset}`);
                    const data = await res.json();
                    return this.normalize(data.data);
                } catch (e) { return this.fetchTrending(); }
            }

            static async fetchTopRated() {
                try {
                    const res = await fetch(`${API_BASE}/anime?sort=-averageRating&page[limit]=10`);
                    const data = await res.json();
                    return this.normalize(data.data);
                } catch (e) { return []; }
            }

            static async fetchPopular(offset = 0) {
                 try {
                    const res = await fetch(`${API_BASE}/anime?sort=popularityRank&page[limit]=12&page[offset]=${offset}`);
                    const data = await res.json();
                    return this.normalize(data.data);
                } catch (e) { return []; }
            }
            
            static async search(query) {
                try {
                    const res = await fetch(`${API_BASE}/anime?filter[text]=${encodeURIComponent(query)}&page[limit]=10`);
                    const data = await res.json();
                    return this.normalize(data.data);
                } catch (e) { return []; }
            }

            static async fetchGenres() {
                try {
                    const res = await fetch(`${API_BASE}/categories?page[limit]=20&sort=-totalMediaCount`);
                    const data = await res.json();
                    return data.data.map(item => ({
                        id: item.id,
                        title: item.attributes.title,
                        slug: item.attributes.slug
                    }));
                } catch(e) { return []; }
            }

            static async fetchDiscoverResults(query, categories) {
                try {
                    let url = `${API_BASE}/anime?sort=-averageRating&page[limit]=15`;
                    if (query) url += `&filter[text]=${encodeURIComponent(query)}`;
                    if (categories && categories.length > 0) url += `&filter[categories]=${categories.join(',')}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    return this.normalize(data.data);
                } catch(e) { return []; }
            }

            static async fetchDetails(id) {
                try {
                    const res = await fetch(`${API_BASE}/anime/${id}?include=categories,animeProductions.producer`);
                    const data = await res.json();
                    const genres = data.included?.filter(inc => inc.type === 'categories').map(inc => inc.attributes.title) || [];
                    const studios = data.included?.filter(inc => inc.type === 'producers').map(inc => inc.attributes.name) || [];
                    return { genres, studios };
                } catch (e) { return { genres: [], studios: [] }; }
            }

            static async fetchCast(title) {
                const query = `query ($search: String) { Media (search: $search, type: ANIME) { characters (sort: [ROLE, RELEVANCE], perPage: 8) { edges { node { name { full } image { medium } } role } } } }`;
                try {
                    const response = await fetch('https://graphql.anilist.co', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify({ query: query, variables: { search: title } })
                    });
                    const data = await response.json();
                    if (!data.data || !data.data.Media) return [];
                    return data.data.Media.characters.edges.map(edge => ({
                        name: edge.node.name.full,
                        image: edge.node.image.medium,
                        role: edge.role
                    }));
                } catch (e) { return []; }
            }

            static async fetchRandomGacha(genreSlug = null) {
                try {
                    let offset = Math.floor(Math.random() * 500);
                    let url = `${API_BASE}/anime?page[limit]=1&page[offset]=${offset}`;
                    if (genreSlug && genreSlug !== 'all') {
                        offset = Math.floor(Math.random() * 100); 
                        url += `&filter[categories]=${genreSlug}&sort=-userCount`;
                    } else {
                        url += `&sort=popularityRank`;
                    }
                    const res = await fetch(url);
                    const data = await res.json();
                    if(data.data && data.data.length > 0) return this.normalize(data.data)[0];
                    const fallback = await fetch(`${API_BASE}/anime?page[limit]=1&sort=popularityRank`);
                    const fbData = await fallback.json();
                    return this.normalize(fbData.data)[0];
                } catch(e) { console.error(e); return null; }
            }

            static normalize(data) {
                if(!data || !Array.isArray(data)) return [];
                return data.map(item => ({
                    id: item.id,
                    title: item.attributes.titles.en || item.attributes.titles.en_jp || item.attributes.canonicalTitle,
                    desc: item.attributes.synopsis || "No description available.",
                    poster: item.attributes.posterImage?.large || item.attributes.posterImage?.original || "https://via.placeholder.com/300x450?text=No+Poster",
                    cover: item.attributes.coverImage?.original || item.attributes.posterImage?.original || "https://via.placeholder.com/1200x600?text=No+Cover",
                    rating: item.attributes.averageRating || '??',
                    year: item.attributes.startDate ? item.attributes.startDate.substring(0,4) : 'TBA',
                    youtubeId: item.attributes.youtubeVideoId,
                    episodeCount: item.attributes.episodeCount || '?',
                    status: item.attributes.status ? item.attributes.status.toUpperCase() : 'UNKNOWN',
                    ageRating: item.attributes.ageRating || 'NR'
                }));
            }
        }

        // --- State ---
        let state = {
            hero: [], curated: [], trending: [], searchResults: [], genres: [], discoverResults: [],
            selectedGenres: new Set(), discoverQuery: '', currentHeroIndex: 0, activeBgId: 1,
            slideInterval: null, menuOpen: false, trendingExpanded: false,
            selectedGachaGenres: new Set(), gachaResult: null
        };

        // --- Utilities ---
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- Render Functions (Missing renderSkeletons added back) ---
        function renderSkeletons() {
            // Hero
            const heroTitleMain = document.getElementById('hero-title-main');
            if(heroTitleMain) heroTitleMain.innerHTML = '<div class="h-16 w-64 bg-white/10 rounded animate-pulse mb-2"></div>';
            
            const heroTitleSub = document.getElementById('hero-title-sub');
            if(heroTitleSub) heroTitleSub.innerHTML = '<div class="h-16 w-32 bg-white/10 rounded animate-pulse"></div>';
            
            const heroDesc = document.getElementById('hero-desc');
            if(heroDesc) heroDesc.innerHTML = '<div class="space-y-3"><div class="h-4 bg-white/10 rounded w-full animate-pulse"></div><div class="h-4 bg-white/10 rounded w-5/6 animate-pulse"></div><div class="h-4 bg-white/10 rounded w-4/6 animate-pulse"></div></div>';

            // Trending
            const trendingGrid = document.getElementById('trending-grid');
            if(trendingGrid) trendingGrid.innerHTML = Array(3).fill(0).map(() => `
                <div class="animate-pulse">
                    <div class="aspect-[2/3] bg-white/5 rounded-lg mb-6 relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-tr from-white/5 to-transparent"></div>
                    </div>
                    <div class="flex justify-between items-start pt-4 border-t border-white/5">
                        <div class="space-y-2 w-3/4">
                            <div class="h-3 w-8 bg-white/10 rounded"></div>
                            <div class="h-5 w-3/4 bg-white/10 rounded"></div>
                        </div>
                        <div class="h-4 w-4 bg-white/10 rounded"></div>
                    </div>
                </div>
            `).join('');

            // Curated
            const curatedRow = document.getElementById('curated-row');
            if(curatedRow) curatedRow.innerHTML = Array(3).fill(0).map(() => `
                <div class="min-w-[85vw] md:min-w-[600px] aspect-[21/9] bg-white/5 rounded-lg animate-pulse relative overflow-hidden shrink-0">
                    <div class="absolute bottom-8 left-8 space-y-3">
                        <div class="h-3 w-24 bg-white/10 rounded"></div>
                        <div class="h-8 w-64 bg-white/10 rounded"></div>
                    </div>
                </div>
            `).join('');
        }

        // --- GACHA LOGIC ---
        function initGachaSection() {
            const container = document.getElementById('gacha-genre-pills');
            const gachaGenres = [
                { title: 'Action', slug: 'action' }, 
                { title: 'Fantasy', slug: 'fantasy' },
                { title: 'Sci-Fi', slug: 'science-fiction' }, 
                { title: 'Romance', slug: 'romance' },
                { title: 'Drama', slug: 'drama' }, 
                { title: 'Thriller', slug: 'thriller' },
                { title: 'Mystery', slug: 'mystery' }, 
                { title: 'Comedy', slug: 'comedy' }
            ];

            container.innerHTML = gachaGenres.map(g => `
                <button 
                    onclick="addGachaRune('${g.slug}', '${g.title}', this)" 
                    class="gacha-pill group relative px-5 py-2 rounded-full border border-white/10 bg-white/5 hover:bg-white hover:text-black transition-all duration-500"
                >
                    <span class="text-[10px] uppercase tracking-widest font-bold">${g.title}</span>
                </button>
            `).join('');

            gsap.to('#magic-ring-1', { rotation: 360, duration: 60, repeat: -1, ease: 'linear' });
            gsap.to('#magic-ring-2', { rotation: -360, duration: 45, repeat: -1, ease: 'linear' });
            gsap.to('#magic-ring-3', { rotation: 120, duration: 80, repeat: -1, ease: 'linear' });
        }

        function addGachaRune(slug, title, btn) {
            state.selectedGachaGenres.add(slug);
            gsap.to(btn, { opacity: 0, filter: "blur(10px)", scale: 0.9, duration: 0.6, ease: "power2.in", onComplete: () => { btn.style.display = 'none'; } });
            const ring = document.getElementById('magic-ring-2');
            const rune = document.createElement('div');
            rune.className = 'absolute text-premium-gold/90 font-serif italic text-[10px] tracking-[0.2em] uppercase font-bold rune-text';
            rune.innerText = title;
            
            const angle = Math.random() * 360;
            const isMobile = window.innerWidth < 768;
            const radius = isMobile ? 125 : 250; 

            gsap.set(rune, { left: '50%', top: '50%', xPercent: -50, yPercent: -50, scale: 0.5, opacity: 0 });
            ring.appendChild(rune);
            gsap.to(rune, { x: Math.cos(angle * Math.PI / 180) * radius, y: Math.sin(angle * Math.PI / 180) * radius, rotation: angle + 90, opacity: 1, scale: 1, duration: 1, ease: "expo.out" });
        }

        function resetGachaState() {
            state.selectedGachaGenres.clear();
            const ring = document.getElementById('magic-ring-2');
            gsap.to(ring.children, { opacity: 0, duration: 0.5, onComplete: () => { ring.innerHTML = ''; } });
            document.querySelectorAll('.gacha-pill').forEach(p => { p.style.display = 'block'; gsap.to(p, { scale: 1, opacity: 1, filter: "blur(0px)", duration: 0.4, delay: 0.2 }); });
            document.getElementById('summon-result').style.opacity = '0';
            document.getElementById('summon-result').style.visibility = 'hidden';
            document.getElementById('summon-placeholder').style.opacity = '0.5';
        }

        async function triggerGachaPull() {
            const card = document.getElementById('summon-container');
            const placeholder = document.getElementById('summon-placeholder');
            const result = document.getElementById('summon-result');
            result.style.opacity = '0'; result.style.visibility = 'hidden'; placeholder.style.opacity = '1';
            gsap.to(['#magic-ring-1', '#magic-ring-2'], { scale: 1.05, duration: 0.3, yoyo: true, repeat: 3 });
            gsap.to('#magic-ring-3', { rotation: '+=360', duration: 1.5, ease: 'power2.inOut' });
            gsap.to(card, { boxShadow: "0 0 30px rgba(212, 175, 55, 0.4)", borderColor: "#D4AF37", duration: 0.5, yoyo: true, repeat: 1 });
            const genreSlug = state.selectedGachaGenres.size > 0 ? Array.from(state.selectedGachaGenres).join(',') : null;
            const anime = await AnimeService.fetchRandomGacha(genreSlug);
            state.gachaResult = anime;
            gsap.to(card, { boxShadow: "none", borderColor: "rgba(255,255,255,0.1)", duration: 0.5 });
            if (anime) {
                document.getElementById('summon-img').src = anime.poster;
                document.getElementById('summon-title').textContent = anime.title;
                document.getElementById('summon-meta').textContent = `${anime.year} • ${anime.rating}%`;
                placeholder.style.opacity = '0'; result.style.visibility = 'visible';
                gsap.fromTo(result, { opacity: 0, filter: 'blur(20px) brightness(3)', scale: 0.9 }, { opacity: 1, filter: 'blur(0px) brightness(1)', scale: 1, duration: 1.2, ease: 'power3.out' });
            }
        }

        // --- RENDER ---
        function renderHero(index) {
            const anime = state.hero[index];
            if(!anime) return;
            const anims = document.querySelectorAll('.hero-anim');
            anims.forEach(el => { el.style.opacity = '0'; el.style.transform = 'translateY(20px)'; });
            setTimeout(() => {
                const words = anime.title.split(' ');
                document.getElementById('hero-title-main').textContent = words.slice(0, Math.ceil(words.length/2)).join(' ');
                document.getElementById('hero-title-sub').textContent = words.slice(Math.ceil(words.length/2)).join(' ');
                document.getElementById('hero-desc').textContent = anime.desc;
                document.getElementById('slide-current').textContent = `0${index + 1}`;
                anims.forEach((el, i) => setTimeout(() => { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; el.style.transition = 'all 0.6s ease-out'; }, i * 100));
            }, 400);
            const nextBgId = state.activeBgId === 1 ? 2 : 1;
            document.getElementById(`hero-bg-${nextBgId}`).innerHTML = `<img src="${anime.cover || anime.poster}" class="w-full h-full object-cover">`;
            document.getElementById(`hero-bg-${nextBgId}`).className = 'bg-layer active-bg';
            document.getElementById(`hero-bg-${state.activeBgId}`).className = 'bg-layer inactive-bg';
            state.activeBgId = nextBgId;
            const bar = document.getElementById('slide-progress');
            bar.style.animation = 'none'; bar.offsetHeight; bar.style.animation = 'progress 8s linear forwards';
        }

        function renderLists() {
            const cRow = document.getElementById('curated-row');
            cRow.innerHTML = '';
            state.curated.forEach(item => {
                const el = document.createElement('div');
                el.className = 'min-w-[85vw] md:min-w-[600px] aspect-[21/9] relative group cursor-pointer snap-center cinematic-card overflow-hidden rounded-lg';
                el.onclick = () => openDetails(item);
                el.innerHTML = `<img src="${item.cover || item.poster}" class="w-full h-full object-cover filter brightness-[0.6] grayscale-[20%] group-hover:grayscale-0 group-hover:brightness-90 duration-700"><div class="absolute bottom-8 left-8 z-10"><p class="text-[10px] tracking-[0.2em] uppercase text-premium-gold mb-2">${item.year} • ${item.ageRating}</p><h4 class="text-3xl font-serif italic text-white">${item.title}</h4></div>`;
                cRow.appendChild(el);
            });
            renderTrendingGrid();
        }

        function renderTrendingGrid() {
            const grid = document.getElementById('trending-grid');
            grid.innerHTML = '';
            const items = state.trendingExpanded ? state.trending : state.trending.slice(0, 3);
            items.forEach((item, idx) => {
                const el = document.createElement('div');
                el.className = 'group cursor-pointer cinematic-card opacity-0 animate-cinematic-fade';
                el.style.animationDelay = `${idx * 100}ms`;
                el.onclick = () => openDetails(item);
                el.innerHTML = `<div class="aspect-[2/3] overflow-hidden mb-6 relative rounded-lg bg-white/5"><img src="${item.poster}" class="w-full h-full object-cover filter saturate-50 group-hover:saturate-100 transition-all duration-700"><div class="absolute top-2 right-2 bg-black/60 px-2 py-1 rounded text-[10px] text-premium-gold border border-premium-gold/30">${item.rating}%</div></div><div><h4 class="text-xl font-serif text-white group-hover:text-premium-gold transition-colors line-clamp-1">${item.title}</h4></div>`;
                grid.appendChild(el);
            });
            const btnText = document.getElementById('trending-btn-text');
            const btnIcon = document.getElementById('trending-btn-icon');
            if(btnText) { btnText.textContent = state.trendingExpanded ? "Show Less" : "Show More"; btnIcon.style.transform = state.trendingExpanded ? "rotate(180deg)" : "rotate(0deg)"; }
        }

        function toggleTrendingExpansion() {
            state.trendingExpanded = !state.trendingExpanded;
            renderTrendingGrid();
            if(!state.trendingExpanded) document.getElementById('grid-title').scrollIntoView({ behavior: 'smooth' });
        }

        async function shuffleTrending() {
            const grid = document.getElementById('trending-grid');
            gsap.to(grid, { opacity: 0, y: 10, duration: 0.3 });
            const offset = Math.floor(Math.random() * 200);
            const items = await AnimeService.fetchPopular(offset);
            if(items.length > 0) { state.trending = items; state.trendingExpanded = false; renderTrendingGrid(); }
            gsap.fromTo(grid, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.4 });
        }

        async function openDetails(animeOrIndex) {
            try {
                let anime = typeof animeOrIndex === 'number' 
                    ? (animeOrIndex === -1 ? state.hero[state.currentHeroIndex] : state.trending[animeOrIndex])
                    : animeOrIndex;

                if (!anime || !anime.id) return;

                const detailsView = document.getElementById('details-view');
                const content = document.getElementById('details-content');
                
                content.innerHTML = '<div class="flex items-center justify-center h-screen"><div class="w-10 h-10 border-2 border-premium-gold rounded-full animate-spin border-t-transparent"></div></div>';
                detailsView.style.visibility = 'visible';
                detailsView.style.opacity = '1';
                document.body.style.overflow = 'hidden';

                const { genres, studios } = await AnimeService.fetchDetails(anime.id);
                const castList = await AnimeService.fetchCast(anime.title);
                
                const safeTitle = anime.title || "Unknown Title";
                const safeDesc = anime.desc || "No description available.";
                const safePoster = anime.poster || "";
                const safeCover = anime.cover || safePoster;
                const epCount = parseInt(anime.episodeCount) || 12;
                
                const studioName = studios[0] || "Unknown Studio";
                const genreTags = genres.slice(0, 4).map(g => `<span class="px-3 py-1 border border-white/20 rounded-full text-xs text-white/70">${g}</span>`).join('');

                const castHTML = castList.length > 0 ? castList.map(c => `
                    <div class="flex flex-col items-center gap-2 min-w-[80px] group/actor">
                        <div class="w-16 h-16 rounded-full bg-white/10 overflow-hidden border border-white/10 group-hover/actor:border-premium-gold transition-colors">
                            <img src="${c.image}" class="w-full h-full object-cover opacity-80 group-hover/actor:opacity-100 transition-opacity">
                        </div>
                        <div class="text-center">
                            <span class="block text-[10px] text-white/90 font-bold leading-tight">${c.name}</span>
                            <span class="block text-[8px] text-white/50 uppercase tracking-wide mt-0.5">${c.role}</span>
                        </div>
                    </div>
                `).join('') : '<div class="text-white/30 text-sm italic">Cast info unavailable</div>';

                const episodesHTML = Array.from({length: Math.min(epCount, 12)}).map((_, i) => `
                    <div class="flex items-center gap-6 p-4 rounded-lg hover:bg-white/5 transition-colors cursor-pointer border-b border-white/5">
                        <div class="w-8 text-premium-gold font-mono text-sm">0${i+1}</div>
                        <div class="flex-1">
                            <h4 class="text-white font-serif text-base">Episode ${i+1}</h4>
                        </div>
                        <span class="text-xs text-white/20 font-mono">24m</span>
                    </div>
                `).join('');

                content.innerHTML = `
                     <div class="absolute inset-0 h-[60vh] w-full overflow-hidden">
                        <img src="${safeCover}" class="w-full h-full object-cover opacity-30 blur-md scale-110">
                        <div class="absolute inset-0 bg-gradient-to-t from-[#020204] via-[#020204]/80 to-transparent"></div>
                    </div>

                    <div class="relative z-20 pt-32 px-6 md:px-24 flex flex-col lg:flex-row gap-16 pb-24">
                        <div class="w-full lg:w-[350px] shrink-0">
                            <div class="aspect-[2/3] rounded-lg overflow-hidden relative shadow-2xl border border-white/10 bg-black mb-6">
                                <img src="${safePoster}" class="w-full h-full object-cover">
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-6 text-center">
                                <div class="bg-white/5 p-3 rounded border border-white/10">
                                    <div class="text-[10px] text-white/40 uppercase tracking-widest">Rating</div>
                                    <div class="text-xl text-premium-gold font-serif italic">${anime.rating}%</div>
                                </div>
                                <div class="bg-white/5 p-3 rounded border border-white/10">
                                    <div class="text-[10px] text-white/40 uppercase tracking-widest">Year</div>
                                    <div class="text-xl text-white font-serif italic">${anime.year}</div>
                                </div>
                            </div>
                            <button class="w-full py-4 bg-white text-black font-sans font-bold tracking-widest uppercase text-xs hover:bg-premium-gold transition-colors mb-3">Add to Library</button>
                        </div>

                        <div class="flex-1 pt-4">
                            <div class="flex flex-wrap gap-3 mb-6">
                                <span class="px-3 py-1 bg-premium-gold/20 text-premium-gold rounded text-xs uppercase tracking-widest font-bold">${anime.status}</span>
                                ${genreTags}
                            </div>

                            <h1 class="text-5xl md:text-7xl font-serif italic text-white mb-8 leading-tight">${safeTitle}</h1>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 mb-10 border-y border-white/10 py-6">
                                <div><div class="text-xs text-white/40 uppercase mb-1">Studio</div><div class="text-white">${studioName}</div></div>
                                <div><div class="text-xs text-white/40 uppercase mb-1">Age Rating</div><div class="text-white">${anime.ageRating}</div></div>
                                <div><div class="text-xs text-white/40 uppercase mb-1">Source</div><div class="text-white">Manga</div></div>
                                <div><div class="text-xs text-white/40 uppercase mb-1">Episodes</div><div class="text-white">${epCount}</div></div>
                            </div>

                            <p class="text-lg text-premium-dim font-light leading-relaxed max-w-3xl mb-12">${safeDesc}</p>
                            
                            <div class="mb-12">
                                <h3 class="text-xl font-serif italic text-white mb-6">Cast & Characters</h3>
                                <div class="flex gap-6 overflow-x-auto pb-4 no-scrollbar items-start">
                                    ${castHTML}
                                </div>
                            </div>

                            <div class="border border-white/10 rounded-xl overflow-hidden bg-white/5">
                                <button onclick="toggleAccordion(this)" class="w-full flex items-center justify-between p-6 hover:bg-white/5 transition-colors">
                                    <h3 class="text-xl font-serif italic text-white">Episodes (${epCount})</h3>
                                    <i data-lucide="chevron-down" class="w-5 h-5 text-white/50 transition-transform duration-300"></i>
                                </button>
                                <div class="accordion-content bg-black/20">
                                    <div class="p-4 space-y-2">
                                        ${episodesHTML}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            } catch (err) { console.error(err); }
        }

        function closeDetails() {
            const detailsView = document.getElementById('details-view');
            detailsView.style.opacity = '0';
            setTimeout(() => {
                detailsView.style.visibility = 'hidden';
                document.body.style.overflow = '';
                document.getElementById('details-content').innerHTML = '';
            }, 600);
        }

        function toggleAccordion(btn) {
            const content = btn.nextElementSibling;
            const icon = btn.querySelector('svg') || btn.querySelector('i');
            
            if (!content) return;

            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                if (icon) icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                if (icon) icon.style.transform = 'rotate(180deg)';
            }
        }

        function toggleMenu() {
            if (state.menuOpen) {
                const tl = gsap.timeline({ onComplete: () => {
                    document.getElementById('menu-overlay').style.visibility = 'hidden';
                }});
                
                tl.to('.menu-item-anim', { y: 20, opacity: 0, duration: 0.3, stagger: 0.05, ease: "power2.in" })
                  .to('.menu-line-deco', { scaleY: 0, duration: 0.4, ease: "power2.in" }, "-=0.2")
                  .to('#menu-overlay', { opacity: 0, duration: 0.4 }, "-=0.2")
                  .to('#menu-line-1', { rotation: 0, y: 0, duration: 0.3 }, "-=0.4")
                  .to('#menu-line-3', { rotation: 0, y: 0, duration: 0.3 }, "-=0.4")
                  .to('#menu-line-2', { opacity: 1, duration: 0.3 }, "-=0.4");
                
                state.menuOpen = false;
            } else {
                document.getElementById('menu-overlay').style.visibility = 'visible';
                
                const tl = gsap.timeline();
                
                tl.to('#menu-line-2', { opacity: 0, duration: 0.2 })
                  .to('#menu-line-1', { y: 6, rotation: 45, duration: 0.3 }, "-=0.2")
                  .to('#menu-line-3', { y: -6, rotation: -45, duration: 0.3 }, "-=0.3")
                  .to('#menu-overlay', { opacity: 1, duration: 0.4 }, "-=0.2")
                  .to('.menu-line-deco', { scaleY: 1, duration: 0.6, ease: "expo.out" }, "-=0.1")
                  .to('.menu-item-anim', { y: 0, opacity: 1, duration: 0.6, stagger: 0.1, ease: "power3.out" }, "-=0.4");
                
                state.menuOpen = true;
            }
        }

        function scrollCurated(direction) {
            const container = document.getElementById('curated-row');
            container.scrollBy({ left: direction * (window.innerWidth * 0.7), behavior: 'smooth' });
        }
        function toggleSearch() {
            const container = document.getElementById('search-container');
            const input = document.getElementById('search-input');
            const isExpanding = !container.classList.contains('search-expanded');
            if (isExpanding) {
                container.classList.add('search-expanded');
                setTimeout(() => input.focus(), 100);
            } else {
                closeSearch();
            }
        }
        function closeSearch() {
            const container = document.getElementById('search-container');
            const overlay = document.getElementById('search-results-overlay');
            const input = document.getElementById('search-input');
            container.classList.remove('search-expanded');
            input.value = '';
            overlay.style.opacity = '0';
            overlay.style.visibility = 'hidden';
        }
        function renderSearchResults(results) {
            const grid = document.getElementById('search-results-grid');
            grid.innerHTML = results.length === 0 ? '<div class="text-white/50 col-span-full">No results.</div>' : results.map((item, index) => `
                <div class="group cursor-pointer cinematic-card" onclick="openDetailsFromSearch(${index})">
                    <img src="${item.poster}" class="w-full h-full object-cover rounded-lg group-hover:scale-105 transition-transform">
                    <h4 class="text-sm mt-2 text-white line-clamp-1">${item.title}</h4>
                </div>`).join('');
        }
        function openDetailsFromSearch(index) { openDetails(state.searchResults[index]); }
        
        async function openDiscover() {
            const view = document.getElementById('discover-view');
            const container = document.getElementById('genre-container');
            
            if(state.genres.length > 0 && container.children.length === 0) {
                container.innerHTML = state.genres.map(g => `<button onclick="toggleGenre('${g.slug}', this)" class="px-6 py-2 rounded-full border border-white/20 text-white/70 hover:bg-white hover:text-black transition-all text-sm genre-btn">${g.title}</button>`).join('');
                updateDiscoverResults();
            }
            view.style.visibility = 'visible'; view.style.opacity = '1';
        }
        function closeDiscover() { 
            const view = document.getElementById('discover-view');
            view.style.opacity = '0';
            setTimeout(() => view.style.visibility = 'hidden', 600);
        }
        function toggleGenre(slug, btn) {
            if(state.selectedGenres.has(slug)) { state.selectedGenres.delete(slug); btn.classList.remove('bg-white','text-black'); btn.classList.add('text-white/70'); }
            else { state.selectedGenres.add(slug); btn.classList.add('bg-white','text-black'); btn.classList.remove('text-white/70'); }
            updateDiscoverResults();
        }
        async function updateDiscoverResults() {
            const grid = document.getElementById('discover-grid');
            grid.innerHTML = '<div class="col-span-full text-center text-white/50">Filtering...</div>';
            const results = await AnimeService.fetchDiscoverResults(state.discoverQuery, Array.from(state.selectedGenres));
            state.discoverResults = results;
            document.getElementById('discover-count').textContent = `${results.length} Results`;
            grid.innerHTML = results.map((item, idx) => `<div class="group cursor-pointer" onclick="openDetailsFromDiscover(${idx})"><img src="${item.poster}" class="rounded-lg mb-2"><div class="text-sm text-white line-clamp-1">${item.title}</div></div>`).join('');
        }
        function openDetailsFromDiscover(index) { openDetails(state.discoverResults[index]); }
        function nextSlide() { state.currentHeroIndex = (state.currentHeroIndex + 1) % state.hero.length; renderHero(state.currentHeroIndex); startHeroTimer(); }
        function prevSlide() { state.currentHeroIndex = (state.currentHeroIndex - 1 + state.hero.length) % state.hero.length; renderHero(state.currentHeroIndex); startHeroTimer(); }
        function startHeroTimer() { clearInterval(state.slideInterval); state.slideInterval = setInterval(nextSlide, 8000); }

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            renderSkeletons();
            const [trending, topRated, popular, genres] = await Promise.all([
                AnimeService.fetchRandomHero(),
                AnimeService.fetchTopRated(),
                AnimeService.fetchPopular(),
                AnimeService.fetchGenres()
            ]);

            state.hero = trending.slice(0, 5);
            state.curated = topRated;
            state.trending = popular;
            state.genres = genres;

            initGachaSection(); 

            const intro = document.getElementById('intro-screen');
            const app = document.getElementById('app-container');
            intro.style.opacity = '0';
            setTimeout(() => { 
                intro.style.display = 'none'; 
                app.classList.remove('opacity-0');
                document.getElementById('slide-total').textContent = `0${state.hero.length}`;
                renderHero(0);
                renderLists(); 
                startHeroTimer();
            }, 1000);

            // Search Listeners
            document.getElementById('search-input').addEventListener('input', debounce(async (e) => {
                const query = e.target.value;
                const overlay = document.getElementById('search-results-overlay');
                const grid = document.getElementById('search-results-grid');

                if(!query || query.length < 3) {
                    overlay.style.opacity = '0';
                    overlay.style.visibility = 'hidden';
                    return;
                }
                
                overlay.style.visibility = 'visible';
                overlay.style.opacity = '1';
                grid.innerHTML = '<div class="text-white/50 col-span-full text-center">Searching...</div>';
                
                const results = await AnimeService.search(query);
                state.searchResults = results;
                renderSearchResults(results);
            }, 300));

            document.getElementById('discover-input').addEventListener('input', debounce((e) => {
                state.discoverQuery = e.target.value;
                updateDiscoverResults();
            }, 500));
        });
    </script>
</body>
</html>
